services:
  anvil:
    image: ghcr.io/foundry-rs/foundry:v1.4.1
    entrypoint: ["anvil"]
    command: ["--host", "0.0.0.0", "--silent"]
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD", "cast", "bn", "--rpc-url", "http://localhost:8545"]
      interval: 1s
      timeout: 5s
      retries: 24
      start_period: 5s

  aztec-node:
    image: aztecprotocol/aztec:4.0.0-devnet.2-patch.1
    command: ["start", "--local-network"]
    ports:
      - "8080:8080"
    environment:
      ARCHIVER_POLLING_INTERVAL_MS: 500
      P2P_BLOCK_CHECK_INTERVAL_MS: 500
      SEQ_TX_POLLING_INTERVAL_MS: 500
      WS_BLOCK_CHECK_INTERVAL_MS: 500
      ARCHIVER_VIEM_POLLING_INTERVAL_MS: 500
      TEST_ACCOUNTS: "true"
      LOG_LEVEL: "info;silent:sequencer;verbose:debug_log"
      DEPLOY_AZTEC_CONTRACTS_SALT: 1
      L1_CHAIN_ID: 31337
      ETHEREUM_HOSTS: "http://anvil:8545"
    depends_on:
      anvil:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "--no-warnings",
          "/usr/src/yarn-project/aztec/dest/bin/index.js",
          "get-node-info",
        ]
      interval: 1s
      timeout: 5s
      retries: 24
      start_period: 30s

  contract-deploy:
    image: nethermind/aztec-fpc-contract-deploy:local
    configs:
      - source: fpc-config
        target: /app/fpc-config.yaml
    volumes:
      - ./configs:/app/configs
    environment:
      AZTEC_NODE_URL: "${AZTEC_NODE_URL:-http://aztec-node:8080}"
      L1_RPC_URL: "${L1_RPC_URL:-http://anvil:8545}"
      FPC_LOCAL_OPERATOR: "${FPC_LOCAL_OPERATOR:-0x089323ce9a610e9f013b661ce80dde444b554e9f6ed9f5167adb234668f0af72}"
      FPC_MASTER_CONFIG: "/app/fpc-config.yaml"
      FPC_CONFIGS_OUT: "/app/configs"
    depends_on:
      aztec-node:
        condition: service_healthy

  attestation:
    image: nethermind/aztec-fpc-attestation:local
    ports:
      - "3000:3000"
    volumes:
      - ./configs:/app/configs:ro
    command: ["--config", "/app/configs/attestation/config.yaml"]
    environment:
      AZTEC_NODE_URL: "${AZTEC_NODE_URL:-http://aztec-node:8080}"
      OPERATOR_SECRET_KEY: "${OPERATOR_SECRET_KEY:-0x2153536ff6628eee01cf4024889ff977a18d9fa61d0e414422f7681cf085c281}"
    depends_on:
      contract-deploy:
        condition: service_completed_successfully

  topup:
    image: nethermind/aztec-fpc-topup:local
    ports:
      - "3001:3001"
    volumes:
      - ./configs:/app/configs:ro
    command: ["--config", "/app/configs/topup/config.yaml"]
    environment:
      AZTEC_NODE_URL: "${AZTEC_NODE_URL:-http://aztec-node:8080}"
      L1_RPC_URL: "${L1_RPC_URL:-http://anvil:8545}"
      L1_OPERATOR_PRIVATE_KEY: "${L1_OPERATOR_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}"
      TOPUP_OPS_PORT: "${TOPUP_OPS_PORT:-3001}"
    depends_on:
      contract-deploy:
        condition: service_completed_successfully

  smoke-fee-entrypoint:
    image: nethermind/aztec-fpc-smoke:local
    profiles: ["smoke-fee-entrypoint"]
    command: ["services/attestation/test/fee-entrypoint-devnet-smoke.ts"]
    environment:
      AZTEC_NODE_URL: "http://aztec-node:8080"
      FPC_SMOKE_L1_RPC_URL: "http://anvil:8545"
    depends_on:
      aztec-node:
        condition: service_healthy

  smoke-credit-fpc:
    image: nethermind/aztec-fpc-smoke:local
    profiles: ["smoke-credit-fpc"]
    command: ["services/attestation/test/credit-fpc-devnet-smoke.ts"]
    environment:
      AZTEC_NODE_URL: "http://aztec-node:8080"
      CREDIT_FPC_SMOKE_L1_RPC_URL: "http://anvil:8545"
    depends_on:
      aztec-node:
        condition: service_healthy

  smoke-deploy:
    image: nethermind/aztec-fpc-smoke:local
    profiles: ["smoke-deploy"]
    entrypoint: ["bash", "-c"]
    command:
      - |
        FPC_LOCAL_OUT=/tmp/deploy-out.json \
          scripts/contract/deploy-fpc-local.sh && \
        FPC_DEPLOY_SMOKE_DEPLOY_OUTPUT=/tmp/deploy-out.json \
          bunx tsx scripts/contract/deploy-fpc-local-smoke.ts
    environment:
      AZTEC_NODE_URL: "http://aztec-node:8080"
      L1_RPC_URL: "http://anvil:8545"
      FPC_DEPLOY_SMOKE_L1_RPC_URL: "http://anvil:8545"
      FPC_DEPLOY_SMOKE_START_LOCAL_NETWORK: "0"
    depends_on:
      aztec-node:
        condition: service_healthy

  smoke-services:
    image: nethermind/aztec-fpc-smoke:local
    profiles: ["smoke-services"]
    command: ["scripts/services/fpc-services-smoke.ts"]
    environment:
      AZTEC_NODE_URL: "http://aztec-node:8080"
      FPC_SERVICES_SMOKE_L1_RPC_URL: "http://anvil:8545"
    depends_on:
      aztec-node:
        condition: service_healthy

configs:
  fpc-config:
    file: ./fpc-config.yaml
